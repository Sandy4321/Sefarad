<link rel="import" href="../../bower_components/polymer/polymer.html">
<script src="dc.custom.facetedSearch.js"></script>




<polymer-element name="faceted-search" class="dc-element">



    <template>

        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>

        <style>
            .panel-title { cursor: pointer; }
            .label { cursor: pointer; }
        </style>


        <div id="accordion" class="panel-group">

            <template repeat="{{d in dimensions}}">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            <div objectToHide="{{d[0]}}" on-click="{{headerClick}}">{{d[0]}}</div>
                        </h4>
                    </div>
                    <div id="{{d[0]}}" class="panel-collapse collapse">
                        <div class="panel-body">
                            <ul class="nav nav-pills nav-stacked">
                                    <template repeat="{{p in d[2]}}">
                                        <li dimension="{{d[0]}}" on-click="{{valueClick}}" class="active">
                                                <span class="label label-primary">{{p[0]}}</span><span class="badge">{{p[1]}}</span>
                                        </li>
                                    </template>
                            </ul>
                        </div>
                    </div>
                </div>
            </template>

        </div>


    </template>

    <script>
        Polymer({

            crossfilter: {},

            chart: {},
            dimensions: [],
            params: ["loading params"],
            values: [],

            geoJSON: {},


            selected: {},

            headerClick: function(event, detail, sender) {
                //console.log("onclick listened "+ this.$.collapseOne);

                var o = this.shadowRoot.getElementById(sender.getAttribute("objectToHide"));
                o.classList.toggle("in");
                //this.$[sender.getAttribute("objectToHide")].classList.toggle("in");
            },

            valueClick: function(event, detail, sender) {
                var value = sender.getElementsByTagName("span")[0].innerText;
                console.log("clicked on "+ value);

                var dim = sender.getAttribute("dimension");

                sender.getElementsByTagName("span")[0].classList.toggle("label-success");

                for (var i= 0; i < this.dimensions.length; i++)
                {

                    if(this.dimensions[i][0] == dim) {
                        console.log("filter!");
                        //this.dimensions[i][1].filter(value);
                        this.dimensions[i][3].filter(value);
                        dc.redrawAll();
                    }

                }


//                var o = this.shadowRoot.getElementById(sender.getAttribute("objectToHide"));
//                o.classList.toggle("in");
                //this.$[sender.getAttribute("objectToHide")].classList.toggle("in");
            },

            ready: function() {
                console.log("faceted-search ready");
            },

            init: function () {

                for (var i= 0; i < this.params.length; i++)
                {
                    var selectorFunction = new Function ("d", "return d."+ this.params[i] +".value;");
                    var dim = this.crossfilter.dimension(selectorFunction);

                    var values = [];
                    var val = dim.group().reduceCount().top(Infinity);
                    for (var j= 0; j < val.length; j++)
                    {
                        values.push([val[j].key, val[j].value]);
                    }

                    var chart = dc.customFacetedSearch();
                    chart.dimension(dim);
                    chart.group(dim.group().reduceCount());

                    var element = [
                        this.params[i],
                        dim,
                        values,
                        chart
                    ];

                    this.dimensions.push(element);



                }



//                //this.classToggler("selected", "in", this.$.collapseOne)
//                //this.$.collapseOne.addEventListener('click', function () {document.querySelector('#collapseOne').classList.toggle("in")});
//                this.params = [];
//                var d1 = this.crossfilter.dimension(function(d) { return d.designation.value; });
//                var countMeasure = d1.group().reduceCount();
//                var paramCounter = countMeasure.top(Infinity);
//
//                for (var i= 0; i < paramCounter.length; i++)
//                {
//                    this.params.push(paramCounter[i].key);
//                }




                //dc.renderAll();
            }
        });
    </script>
</polymer-element>
