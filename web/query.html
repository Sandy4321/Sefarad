<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sefarad 2.0 | SPARQL Editor</title>
    <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>

    <!-- ------------------------------- STYLE LINKS ZONE -------------------------------------- -->

    <link href='//cdn.jsdelivr.net/yasqe/2.3.8/yasqe.min.css' rel='stylesheet' type='text/css'/>
    <link href='//cdn.jsdelivr.net/yasr/2.4.12/yasr.min.css' rel='stylesheet' type='text/css'/>


    <!-- ------------------------------- end/ STYLE LINKS ZONE --------------------------------- -->

    <!-- Polymer: Load Polymer platform support before any code that touches the DOM. -->
    <script src="bower_components/webcomponentsjs/webcomponents.min.js"></script>
    <!-- Dart Support -->
    <script src="packages/web_components/dart_support.js"></script>

    <!-- Bootstrap 3.3.2 -->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <!-- FontAwesome 4.3.0 -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet"
          type="text/css"/>
    <!-- Ionicons 2.0.0 -->
    <link href="http://code.ionicframework.com/ionicons/2.0.0/css/ionicons.min.css" rel="stylesheet" type="text/css"/>
    <!-- Theme style -->
    <link href="dist/css/AdminLTE.min.css" rel="stylesheet" type="text/css"/>
    <!-- AdminLTE Skins. Choose a skin from the css/skins
         folder instead of downloading all of them to reduce the load. -->
    <link href="dist/css/skins/_all-skins.min.css" rel="stylesheet" type="text/css"/>
    <!-- iCheck -->
    <link href="plugins/iCheck/flat/blue.css" rel="stylesheet" type="text/css"/>
    <!-- Own Css -->
    <link href="common.css" rel="stylesheet" type="text/css"/>
    <!-- Morris chart -->
    <link href="plugins/morris/morris.css" rel="stylesheet" type="text/css"/>
    <!-- jvectormap -->
    <link href="plugins/jvectormap/jquery-jvectormap-1.2.2.css" rel="stylesheet" type="text/css"/>
    <!-- Date Picker -->
    <link href="plugins/datepicker/datepicker3.css" rel="stylesheet" type="text/css"/>
    <!-- Daterange picker -->
    <link href="plugins/daterangepicker/daterangepicker-bs3.css" rel="stylesheet" type="text/css"/>
    <!-- bootstrap wysihtml5 - text editor -->
    <link href="plugins/bootstrap-wysihtml5/bootstrap3-wysihtml5.min.css" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->


    <!-- ------------------------------- SCRIPTS IMPORT ZONE ----------------------------------- -->



    <!-- ------------------------------- end/ SCRIPTS IMPORT ZONE ------------------------------ -->


    <!-- ------------------------------- POLYMER COMPONENTS IMPORT ZONE ------------------------ -->

    <link href="polymer-elements/paper-action-dialog/paper-action-dialog.html" rel="import">
    <link href="polymer-elements/paper-button/paper-button.html" rel="import">

    <!-- ------------------------------- end/ POLYMER COMPONENTS IMPORT ZONE ------------------- -->


</head>
<body class="skin-blue">
<div class="wrapper">

    <paper-shadow class="card" z="2"><header class="main-header">
        <!-- Logo -->
        <a href="dashboard.html" class="logo"><b>Sefarad</b>-2.0</a>
        <!-- Header Navbar: style can be found in header.less -->
        <nav class="navbar navbar-static-top" role="navigation">
            <!-- Sidebar toggle button-->
            <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
                <span class="sr-only">Toggle navigation</span>
            </a>

            <div class="navbar-custom-menu">
                <ul class="nav navbar-nav">
                </ul>
            </div>
        </nav>
    </header>
    </paper-shadow>
    <!-- Left side column. contains the logo and sidebar -->
    <aside class="main-sidebar">
        <!-- sidebar: style can be found in sidebar.less -->
        <section class="sidebar">

            <!-- sidebar menu: : style can be found in sidebar.less -->
            <ul class="sidebar-menu">
                <li class="header">MAIN NAVIGATION</li>

                <li>
                    <a href="dashboard.html">
                        <i class="fa fa-pie-chart"></i> <span>Dashboard</span>
                    </a>
                </li>
                <li class="treeview active">
                    <a href="#">
                        <i class="fa fa-database"></i> <span>Query</span><i class="fa fa-angle-left pull-right"></i>
                    </a>
                    <ul class="treeview-menu">
                        <li class="active"><a href="query.html"><i class="fa fa-circle-o"></i> SPARQL Editor</a></li>
                        <li><a href="newquery.html"><i class="fa fa-circle-o"></i> Add Query</a></li>
                    </ul>
                </li>

            </ul>
        </section>
        <!-- /.sidebar -->
    </aside>

    <!-- Right side column. Contains the navbar and content of the page -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1 horizontal layout>
                Sparql Editor
                <small horizontal layout style="margin-top: 5px">Choose the query and check the result

                    <template is="auto-binding">

                        <section on-tap="{{toggleDialog1}}">

                            <button class="fa fa-question-circle">
                            </button>

                            <paper-action-dialog class="size-position" backdrop autoCloseDisabled layered="false">
                                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>

                                <paper-button affirmative autofocus>Tap me to close</paper-button>
                            </paper-action-dialog>

                        </section>
                    </template>
                </small>
            </h1>
            <ol class="breadcrumb">
                <li><a href="#"> Home</a></li>
                <li class="active"><i class="fa fa-database"></i>    Sparql Editor</li>
            </ol>
        </section>

        <!-- Main content -->
        <section class="content">

            <div id="queries">
                <br>
                <p class="text-light-blue">Select a query template:</p>
                <select style="width: 50%;" class="form-control" id="querySelector"></select>
                <br>
                <p class="text-light-blue">Select parameters to fill the template:</p>
                <div id="paramSelector"></div>
                <br>

                <p class="text-light-blue">Edit your query:</p>
                <paper-shadow class="card" z="2">
                    <div id="yasqe" style="padding-bottom: 15px"></div>
                </paper-shadow>
                <br>

                <a class="btn btn-app center-block" id="queryButton">
                    <i class="fa fa-play"></i> Execute Query
                </a>

                <div class="alert alert-danger alert-dismissable hide" id="queryError">
                    <i class="fa fa-ban"></i>

                    <b>Query failed</b>
                </div>

                <div class="alert alert-success alert-dismissable hide" id="querySuccess">
                    <i class="fa fa-check"></i>

                    <b>Query success</b>
                </div>

                <paper-shadow class="card" z="2">
                    <div id="yasr"></div>
                </paper-shadow>
            </div>



        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->
    <footer class="main-footer">
        <div class="pull-right hidden-xs">
            <b>Version</b> 2.0
        </div>

        <strong>Powered by <a href="https://github.com/gsi-upm/Sefarad-2.0">Sefarad 2.0</a>
            @<a href="http://www.gsi.dit.upm.es/">Grupo de Sistemas Inteligentes</a></strong>
        - Universidad Polit√©cnica de Madrid.
    </footer>
</div>
<!-- ./wrapper -->

<!-- jQuery 2.1.3 -->
<script src="plugins/jQuery/jQuery-2.1.3.min.js"></script>
<!-- jQuery UI 1.11.2 -->
<script src="http://code.jquery.com/ui/1.11.2/jquery-ui.min.js" type="text/javascript"></script>
<!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
<script>
    $.widget.bridge('uibutton', $.ui.button);
</script>
<!-- Bootstrap 3.3.2 JS -->
<script src="bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
<!-- Dart -->
<script type="application/dart" src="query.dart"></script>
<script type="text/javascript" src="packages/browser/dart.js"></script>
<!-- Morris.js charts -->
<script src="http://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="plugins/morris/morris.min.js" type="text/javascript"></script>
<!-- Sparkline -->
<script src="plugins/sparkline/jquery.sparkline.min.js" type="text/javascript"></script>
<!-- jvectormap -->
<script src="plugins/jvectormap/jquery-jvectormap-1.2.2.min.js" type="text/javascript"></script>
<script src="plugins/jvectormap/jquery-jvectormap-world-mill-en.js" type="text/javascript"></script>
<!-- jQuery Knob Chart -->
<script src="plugins/knob/jquery.knob.js" type="text/javascript"></script>
<!-- daterangepicker -->
<script src="plugins/daterangepicker/daterangepicker.js" type="text/javascript"></script>
<!-- datepicker -->
<script src="plugins/datepicker/bootstrap-datepicker.js" type="text/javascript"></script>
<!-- Bootstrap WYSIHTML5 -->
<script src="plugins/bootstrap-wysihtml5/bootstrap3-wysihtml5.all.min.js" type="text/javascript"></script>
<!-- iCheck -->
<script src="plugins/iCheck/icheck.min.js" type="text/javascript"></script>
<!-- Slimscroll -->
<script src="plugins/slimScroll/jquery.slimscroll.min.js" type="text/javascript"></script>
<!-- FastClick -->
<script src='plugins/fastclick/fastclick.min.js'></script>
<!-- AdminLTE App -->
<script src="dist/js/app.min.js" type="text/javascript"></script>

<!-- AdminLTE dashboard demo (This is only for demo purposes) -->
<script src="dist/js/pages/dashboard.js" type="text/javascript"></script>

<!-- AdminLTE for demo purposes -->
<script src="dist/js/demo.js" type="text/javascript"></script>

<script src='//cdn.jsdelivr.net/yasqe/2.3.8/yasqe.bundled.min.js'></script>
<script src='//cdn.jsdelivr.net/yasr/2.4.12/yasr.bundled.min.js'></script>
<script src='plugins/papaparse/papaparse.min.js'></script>

<script type="text/javascript">

    var _csvResource = "./assets/" + "SlovakianDemoSparqlQueries.csv";
    var _editorEndpoint = 'http://demos.gsi.dit.upm.es/fuseki/geo/query?query=';
    var myEl2 = document.getElementById('querySelector');
    var parsedData = JSON.parse(localStorage.getItem("querysSaved")) || {};

    //configuration
    var queries = [];
    var yasqe = YASQE(document.getElementById("yasqe"), {
        sparql: {
            showQueryButton: false,
            callbacks:{
                success: function(data){
                    console.log("success", data);
                }
            },
            createShareLink: false
        }
    });
    YASR.plugins.table.defaults.datatable.scrollX = true;
    YASR.plugins.table.defaults.datatable.scrollCollapse = true;
    YASR.plugins.table.defaults.datatable.autoWidth = true;
    YASR.plugins.table.defaults.datatable.scrollY = "300px";
    YASR.plugins.rawResponse.defaults.scrollbarStyle = "native";
    var yasr = YASR(document.getElementById("yasr"), {
        //this way, the URLs in the results are prettified using the defined prefixes in the query
        getUsedPrefixes: yasqe.getPrefixesFromQuery
    });
    // end of configuration

    //This function parse the csv table to take its data.
    var googleSpreadsheetURI = "" + _csvResource;
    Papa.parse(
            googleSpreadsheetURI, {
                download: true,
                complete: function (json) {
                    // here populate the list from the json data
                    var paramNo;
                    for (var i = 1; i < json.data.length; i++) {
                        //How many params?
                        paramNo = 0;
                        try {
                            paramNo = parseInt(json.data[i][5], 10);
                        } catch (e) {
                        }
                        queries.push({
                            linkedResources: json.data[i][0],
                            showInDemo: json.data[i][1].trim(),
                            name: json.data[i][2],
                            queryTemplate: json.data[i][3],
                            description: json.data[i][4],
                            paramNo: paramNo,
                            paramNames: json.data[i][6]
                        });
                        //Here we add a variable number of parameter rows, each with its values,
                        //in the format: param0, param1...
                        for (var j = 0; j < paramNo; j++) {
                            queries[i - 1]["param" + j] = json.data[i][7 + j];
                        }
                    }
                    //Here we populate the query form selector with query names
                    var queryAux;
                    for (i = 0; i < queries.length; i++) {
                        queryAux = queries[i];
                        if (queryAux.showInDemo == "yes") {
                            $("#querySelector").append('<option style="width: 50%;" value="' + i + '">' + queryAux.name + "</option>");
                            //$("#queryName").append('<option value="'+i+'">'+ (i+2) +" "+query.name+"</option>");
                        }
                    }
                    $("#querySelector").change();
                }
            });
    $("#queryButton").click(function (e) {
        e.preventDefault();
        executeQuery();
    });

    //Receives the id of the selector and populate it with the values of the corresponding parameter
    function populateParametersSelector(id, values) {

        values = values.split(",");

        //$(id).append('<option value="">choose parameters</option>');
        for (var i = 0; i < values.length; i++) {
            $(id).append('<option style="width: 50%" value="' + values[i].trim() + '">' + values[i].trim() + "</option>");
        }
    }

    var onSelectorChange = function (selectorOrder) {
        console.log("selectorOnChange for selector with order: " + selectorOrder);
        // update the query template using selected parameters
        var i = $("#querySelector").val();
        var query = queries[i];
        var queryTemplate = query.queryTemplate.trim();
        var paramNo = query.paramNo;
        var paramNames = query.paramNames;
        var pNames = paramNames.trim().split(/\s+/);
        var selectedParameters = "";
        //Now we compose a string with the selected parameters (or the param name if not chosen yet)
        for (var i = 0; i < paramNo; i++) {
            if ($("#selector" + i).val() == "") {
                selectedParameters += "<" + pNames[i] + "> ";
                console.log("empty parameter");
            }
            else {
                console.log("value selected: " + document.getElementById("selector" + i).value);
                //var values = query['param'+i].split(",");
                selectedParameters += (document.getElementById("selector" + i).value + " ");
            }

        }
        console.log(selectedParameters);
        //selectedParameters = $("#paramSelector").val();
        //var paramDefinition = query.paramNames;
        queryTemplate = populateQueryWithStaticParams(queryTemplate, paramNames, selectedParameters, paramNo);
        yasqe.setValue(queryTemplate);
    };

    //ExecuteQuery function. Still not generalized, it takes "restaurants" info from our endpoint at gsi's alpha
    function executeQuery() {

        $("#querySuccess").addClass("hide");
        $("#queryError").addClass("hide");

        var _query = yasqe.getValue().replace(/(\r\n|\n|\r)/gm, "");
        console.log(_query);
        var temporal = _editorEndpoint + encodeURIComponent(_query);
        var req = new XMLHttpRequest();
        req.open("GET", temporal, true);
        var params = encodeURIComponent(_query);
        req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        req.setRequestHeader("Accept", "application/sparql-results+json");
        req.send();
        req.onreadystatechange = function () {
            if (req.readyState == 4) {
                if (req.status == 200) {

                    var res = eval("(" + req.responseText + ")");
                    var data = JSON.stringify(res.results.bindings);
                    console.log(data);
                    $("#querySuccess").removeClass('hide');
                    //ko.mapping.fromJSON(data, vm.viewData);
                    //updateWidgets(true);
                    yasr.setResponse({
                        response: res,
                        contentType: req.getResponseHeader("Content-Type")
                    });





                } else {
                    $("#queryError").removeClass('hide');

                }
            }
        };
        return false;
    };

    //This function takes a list of parameter names and another list of parameters values.
    //Then looks for every parameter name in the query code and replace it with its parameter value.
    //parameterValues is a string containing all parameters values selected one after another ex:["Salamanca queso barato"]
    function populateQueryWithStaticParams(query, parameterNames, parameterValues) {
        var pValues = parameterValues.trim().split(/\s+/);
        var pNames = parameterNames.trim().split(/\s+/);


        for (i = 0; i < pNames.length; i++) {
            var re = new RegExp("<" + pNames[i] + ">", "g");
            query = query.replace(re, pValues[i]);
        }
        return query;
    }


    $("#querySelector").change(function () {
        // update param list
        var j;
        for(j = 0; j<myEl2.length; j++){
            if(parsedData[j] != undefined ) {
                if (myEl2.options[myEl2.selectedIndex].text == parsedData[j]["Name"]) {
                    yasqe.setValue(parsedData[j].Query);
                    $("#paramSelector").empty();
                    return;
                }
            }
        }
        var i = $("#querySelector").val();
        var query = queries[i];
        var paramNo = query.paramNo;
        var description = query.description;
        var queryTemplate = query.queryTemplate.trim();
        var paramNames = query.paramNames;


        //put template query into the box (without replacing the parameters in the text)
        yasqe.setValue(queryTemplate);
        $("#description").text(description);

        //Create as many selectors as params for the selected query
        $("#paramSelector").empty();
        for (var i = 0; i < paramNo; i++) {
            var id = "selector" + i;
            var selectorAux = $("#paramSelector").append("<select style='width: 50%;' class=form-control id=" + id + ">");
            $("#selector" + i).append('<option style="width: 50%; font-weight: bold;" value="' + paramNames.split(" ")[i] + '"><strong>' + paramNames.split(" ")[i] + "</strong></option>");

            //populate the selector with its parameter values
            populateParametersSelector("#selector" + i, query["param" + i]);

            //assign onChange function, we pass the index of the option chosen
            $("#selector" + i).change(function (handler) {
                //console.log("selectorOnChange for selector with id: " + handler.srcElement.attributes.id.value);
                onSelectorChange(handler.currentTarget.attributes.id.value.slice(-1));
            });

        }

    });



    var scope = document.querySelector('template[is=auto-binding]');

    scope.toggleDialog1 = function(e) {
        if (e.target.localName != 'button') {
            return;
        }
        var d = e.target.nextElementSibling;
        if (!d) {
            return;
        }
        d.toggle();
    };

    scope.transitions = [
        'core-transition-center',
        'core-transition-top',
        'core-transition-bottom',
        'core-transition-left',
        'core-transition-right'
    ];

    scope.toggleDialog2 = function(e) {
        if (e.target.localName != 'button') {
            return;
        }
        scope.transition = e.target.getAttribute('transition');
        document.getElementById('dialog2').toggle();
    };

</script>

</body>
</html>