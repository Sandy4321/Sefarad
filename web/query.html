<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sefarad 2.0 | SPARQL Editor</title>
    <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>

    <!-- ------------------------------- STYLE LINKS ZONE -------------------------------------- -->

    <link href='//cdn.jsdelivr.net/yasqe/2.3.8/yasqe.min.css' rel='stylesheet' type='text/css'/>
    <link href='//cdn.jsdelivr.net/yasr/2.4.12/yasr.min.css' rel='stylesheet' type='text/css'/>


    <!-- ------------------------------- end/ STYLE LINKS ZONE --------------------------------- -->

    <!-- Polymer: Load Polymer platform support before any code that touches the DOM. -->
    <script src="bower_components/webcomponentsjs/webcomponents.min.js"></script>
    <!-- Dart Support -->
    <script src="packages/web_components/dart_support.js"></script>

    <!-- Bootstrap 3.3.2 -->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <!-- FontAwesome 4.3.0 -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet"
          type="text/css"/>
    <!-- Ionicons 2.0.0 -->
    <link href="http://code.ionicframework.com/ionicons/2.0.0/css/ionicons.min.css" rel="stylesheet" type="text/css"/>
    <!-- Theme style -->
    <link href="dist/css/AdminLTE.min.css" rel="stylesheet" type="text/css"/>
    <!-- AdminLTE Skins. Choose a skin from the css/skins
         folder instead of downloading all of them to reduce the load. -->
    <link href="dist/css/skins/_all-skins.min.css" rel="stylesheet" type="text/css"/>
    <!-- iCheck -->
    <link href="plugins/iCheck/flat/blue.css" rel="stylesheet" type="text/css"/>
    <!-- Own Css -->
    <link href="common.css" rel="stylesheet" type="text/css"/>
    <!-- Morris chart -->
    <link href="plugins/morris/morris.css" rel="stylesheet" type="text/css"/>
    <!-- jvectormap -->
    <link href="plugins/jvectormap/jquery-jvectormap-1.2.2.css" rel="stylesheet" type="text/css"/>
    <!-- Date Picker -->
    <link href="plugins/datepicker/datepicker3.css" rel="stylesheet" type="text/css"/>
    <!-- Daterange picker -->
    <link href="plugins/daterangepicker/daterangepicker-bs3.css" rel="stylesheet" type="text/css"/>
    <!-- bootstrap wysihtml5 - text editor -->
    <link href="plugins/bootstrap-wysihtml5/bootstrap3-wysihtml5.min.css" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->


    <!-- ------------------------------- SCRIPTS IMPORT ZONE ----------------------------------- -->



    <!-- ------------------------------- end/ SCRIPTS IMPORT ZONE ------------------------------ -->


    <!-- ------------------------------- POLYMER COMPONENTS IMPORT ZONE ------------------------ -->

    <link href="polymer-elements/paper-action-dialog/paper-action-dialog.html" rel="import">
    <link href="polymer-elements/paper-button/paper-button.html" rel="import">

    <!-- ------------------------------- end/ POLYMER COMPONENTS IMPORT ZONE ------------------- -->


</head>
<body class="skin-blue">
<div class="wrapper">

    <paper-shadow class="card" z="2"><header class="main-header">
        <!-- Logo -->
        <a href="dashboard.html" class="logo"><b>Sefarad</b>-2.0</a>
        <!-- Header Navbar: style can be found in header.less -->
        <nav class="navbar navbar-static-top" role="navigation">
            <!-- Sidebar toggle button-->
            <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
                <span class="sr-only">Toggle navigation</span>
            </a>

            <div class="navbar-custom-menu">
                <ul class="nav navbar-nav">
                </ul>
            </div>
        </nav>
    </header>
    </paper-shadow>
    <!-- Left side column. contains the logo and sidebar -->
    <aside class="main-sidebar">
        <!-- sidebar: style can be found in sidebar.less -->
        <section class="sidebar">

            <!-- sidebar menu: : style can be found in sidebar.less -->
            <ul class="sidebar-menu">
                <li class="header">MAIN NAVIGATION</li>

                <li>
                    <a href="dashboard.html">
                        <i class="fa fa-pie-chart"></i> <span>Dashboard</span>
                    </a>
                </li>
                <li class="treeview active">
                    <a href="#">
                        <i class="fa fa-database"></i> <span>Query</span><i class="fa fa-angle-left pull-right"></i>
                    </a>
                    <ul class="treeview-menu">
                        <li class="active"><a href="query.html"><i class="fa fa-circle-o"></i> SPARQL Editor</a></li>
                        <li><a href="newquery.html"><i class="fa fa-circle-o"></i> Add Query</a></li>
                    </ul>
                </li>

            </ul>
        </section>
        <!-- /.sidebar -->
    </aside>

    <!-- Right side column. Contains the navbar and content of the page -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1 horizontal layout>
                Sparql Editor
                <small horizontal layout style="margin-top: 5px">Choose the query and check the result

                    <template is="auto-binding">

                        <section on-tap="{{toggleDialog1}}">

                            <button class="fa fa-question-circle">
                            </button>

                            <paper-action-dialog class="size-position" backdrop autoCloseDisabled layered="false">
                                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>

                                <paper-button affirmative autofocus>Tap me to close</paper-button>
                            </paper-action-dialog>

                        </section>
                    </template>
                </small>
            </h1>
            <ol class="breadcrumb">
                <li><a href="#"> Home</a></li>
                <li class="active"><i class="fa fa-database"></i>    Sparql Editor</li>
            </ol>
        </section>

        <!-- Main content -->
        <section class="content">

            <div id="queries">
                <br>

                <p class="text-light-blue">Select a query template:</p>
                <select style="width: 50%;" class="form-control" id="querySelector">
                    <option ng-repeat="query in querys" ng-value="query.Name">{{query.Name}}</option>
                </select>
                <br>
                <p class="text-light-blue">Select parameters to fill the template:</p>
                <div id="paramSelector"></div>
                <br>

                <p class="text-light-blue">Edit your query:</p>
                <paper-shadow class="card" z="2">
                    <div id="yasqe" style="padding-bottom: 15px"></div>
                </paper-shadow>
                <br>

                <a class="btn btn-app center-block" id="queryButton">
                    <i class="fa fa-play"></i> Execute Query
                </a>

                <div class="alert alert-danger alert-dismissable hide" id="queryError">
                    <i class="fa fa-ban"></i>

                    <b>Query failed</b>
                </div>

                <div class="alert alert-success alert-dismissable hide" id="querySuccess">
                    <i class="fa fa-check"></i>

                    <b>Query success</b>
                </div>

                <paper-shadow class="card" z="2">
                    <div id="yasr"></div>
                </paper-shadow>
            </div>



        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->
    <footer class="main-footer">
        <div class="pull-right hidden-xs">
            <b>Version</b> 2.0
        </div>

        <strong>Powered by <a href="https://github.com/gsi-upm/Sefarad-2.0">Sefarad 2.0</a>
            @<a href="http://www.gsi.dit.upm.es/">Grupo de Sistemas Inteligentes</a></strong>
        - Universidad Polit√©cnica de Madrid.
    </footer>
</div>
<!-- ./wrapper -->

<!-- jQuery 2.1.3 -->
<script src="plugins/jQuery/jQuery-2.1.3.min.js"></script>
<!-- jQuery UI 1.11.2 -->
<script src="http://code.jquery.com/ui/1.11.2/jquery-ui.min.js" type="text/javascript"></script>
<!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
<script>
    $.widget.bridge('uibutton', $.ui.button);
</script>
<!-- Bootstrap 3.3.2 JS -->
<script src="bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
<!-- Dart -->
<script type="application/dart" src="query.dart"></script>
<script type="text/javascript" src="packages/browser/dart.js"></script>
<!-- Morris.js charts -->
<script src="http://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="plugins/morris/morris.min.js" type="text/javascript"></script>
<!-- Sparkline -->
<script src="plugins/sparkline/jquery.sparkline.min.js" type="text/javascript"></script>
<!-- jvectormap -->
<script src="plugins/jvectormap/jquery-jvectormap-1.2.2.min.js" type="text/javascript"></script>
<script src="plugins/jvectormap/jquery-jvectormap-world-mill-en.js" type="text/javascript"></script>
<!-- jQuery Knob Chart -->
<script src="plugins/knob/jquery.knob.js" type="text/javascript"></script>
<!-- daterangepicker -->
<script src="plugins/daterangepicker/daterangepicker.js" type="text/javascript"></script>
<!-- datepicker -->
<script src="plugins/datepicker/bootstrap-datepicker.js" type="text/javascript"></script>
<!-- Bootstrap WYSIHTML5 -->
<script src="plugins/bootstrap-wysihtml5/bootstrap3-wysihtml5.all.min.js" type="text/javascript"></script>
<!-- iCheck -->
<script src="plugins/iCheck/icheck.min.js" type="text/javascript"></script>
<!-- Slimscroll -->
<script src="plugins/slimScroll/jquery.slimscroll.min.js" type="text/javascript"></script>
<!-- FastClick -->
<script src='plugins/fastclick/fastclick.min.js'></script>
<!-- AdminLTE App -->
<script src="dist/js/app.min.js" type="text/javascript"></script>

<!-- AdminLTE dashboard demo (This is only for demo purposes) -->
<script src="dist/js/pages/dashboard.js" type="text/javascript"></script>

<!-- AdminLTE for demo purposes -->
<script src="dist/js/demo.js" type="text/javascript"></script>

<script src='//cdn.jsdelivr.net/yasqe/2.3.8/yasqe.bundled.min.js'></script>
<script src='//cdn.jsdelivr.net/yasr/2.4.12/yasr.bundled.min.js'></script>
<script src='plugins/papaparse/papaparse.min.js'></script>

<script type="text/javascript">

    var _editorEndpoint = 'http://dbpedia.org/sparql?default-graph-uri=http%3A%2F%2Fdbpedia.org&query=';
    var myEl2 = document.getElementById('querySelector');
    var parsedData = {};
    $.getJSON("querys.json", function (data) {
        parsedData = data;
        if(localStorage.getItem('querysSaved') != null )
            if(localStorage.getItem('querysSaved').length != 0 ) {
                var jsonLocal = localStorage.getItem("querysSaved");
                jsonLocal = jsonLocal.substring(1, jsonLocal.length-1);
                var local = JSON.parse(jsonLocal);
                parsedData.push(local);
            }
    });
    window.onload = function() {
        if(parsedData[0] != undefined )
            yasqe.setValue(parsedData[0]["Query"]);
    };

    //configuration
    var yasqe = YASQE(document.getElementById("yasqe"), {
        sparql: {
            showQueryButton: false,
            callbacks:{
                success: function(data){
                    console.log("success", data);
                }
            },
            createShareLink: false
        }
    });
    YASR.plugins.table.defaults.datatable.scrollX = true;
    YASR.plugins.table.defaults.datatable.scrollCollapse = true;
    YASR.plugins.table.defaults.datatable.autoWidth = true;
    YASR.plugins.table.defaults.datatable.scrollY = "300px";
    YASR.plugins.rawResponse.defaults.scrollbarStyle = "native";
    var yasr = YASR(document.getElementById("yasr"), {
        //this way, the URLs in the results are prettified using the defined prefixes in the query
        getUsedPrefixes: yasqe.getPrefixesFromQuery
    });

    $("#queryButton").click(function (e) {
        e.preventDefault();
        executeQuery();
    });

    //ExecuteQuery function. Still not generalized, it takes "restaurants" info from our endpoint at gsi's alpha
    function executeQuery() {

        $("#querySuccess").addClass("hide");
        $("#queryError").addClass("hide");

        var _query = yasqe.getValue().replace(/(\r\n|\n|\r)/gm, "");
        console.log(_query);
        var temporal = _editorEndpoint + encodeURIComponent(_query);
        var req = new XMLHttpRequest();
        req.open("GET", temporal, true);
        var params = encodeURIComponent(_query);
        req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        req.setRequestHeader("Accept", "application/sparql-results+json");
        req.send();
        req.onreadystatechange = function () {
            if (req.readyState == 4) {
                if (req.status == 200) {

                    var res = eval("(" + req.responseText + ")");
                    var data = JSON.stringify(res.results.bindings);
                    console.log(data);
                    $("#querySuccess").removeClass('hide');
                    //ko.mapping.fromJSON(data, vm.viewData);
                    //updateWidgets(true);
                    yasr.setResponse({
                        response: res,
                        contentType: req.getResponseHeader("Content-Type")
                    });





                } else {
                    $("#queryError").removeClass('hide');

                }
            }
        };
        return false;
    };

    function populateQueryWithParams(){
        // update param list
        var j;
        for(j = 0; j<myEl2.length; j++){
            if(parsedData[j] != undefined ) {
                if (myEl2.value == parsedData[j]["Name"]) {
                    var start = myEl2.value.indexOf("<");
                    var end = myEl2.value.indexOf(">");
                    var paramValue = myEl2.value.substring(start, end+1);
                    var query = parsedData[j]["Query"];
                    $("#paramSelector").empty();
                    if(parsedData[j]["Parameters"].length != 0) {
                        var id = "selector";
                        $("#paramSelector").append("<select style='width: 50%;' class=form-control id=" + id + ">");
                        for (var i = 0; i < parsedData[j]["Parameters"].length; i++) {
                            $("#selector").append('<option style="width: 50%; font-weight: bold;" value="' + parsedData[j]["Parameters"][i] + '"><strong>' + parsedData[j].Parameters[i] + "</strong></option>");
                        }
                        var selectedParameters = document.getElementById("selector").value;
                        query = query.replace(paramValue, selectedParameters);
                        paramValue = selectedParameters;
                        $("#selector").change(function () {
                            var selectedParameters = document.getElementById("selector").value;
                            query = query.replace(paramValue, selectedParameters);
                            paramValue = selectedParameters;
                            yasqe.setValue(query);
                        });
                    }

                    yasqe.setValue(query);
                    return;
                }
            }
        }
    }

    $("#querySelector").change(function () {
        populateQueryWithParams();
    });


    var scope = document.querySelector('template[is=auto-binding]');

    scope.toggleDialog1 = function(e) {
        if (e.target.localName != 'button') {
            return;
        }
        var d = e.target.nextElementSibling;
        if (!d) {
            return;
        }
        d.toggle();
    };

</script>

</body>
</html>